const database = [
    {
        id: 'vnd331',
        title: 'Radisson Royal Hotel',
        details: 'Отель расположен в 4 минутах ходьбы от станции метро «Маяковская». К услугам гостей фитнес-центр и спа-центр с сауной и гидромассажной ванной.',
        photos: ['vnd331.png', 'vnd331.png'],
        coordinates: [59.9322936, 30.3460129],
        bookedDates: [],
        price: 12000
    },
    {
        id: 'ab2e2',
        title: 'Номера на Садовой',
        details: 'Расположен в 7 минутах ходьбы от Невского проспекта. К услугам гостей круглосуточная стойка регистрации и бесплатный Wi-Fi.',
        photos: ['ab2e2.png', 'ab2e2.png'],
        coordinates: [59.930325, 30.3291592],
        bookedDates: [],
        price: 4500
    },
    {
        id: 'mvm32l',
        title: 'Мини Отель на Невском 136',
        details: 'Мини-отель расположен в Санкт-Петербурге, в 5 минутах ходьбы от станции метро «Площадь Восстания» и Московского железнодорожного вокзала.',
        photos: ['mvm32l.png', 'mvm32l.png'],
        coordinates: [59.9299603, 30.3658932],
        bookedDates: [],
        price: 3800
    },
    {
        id: 'bvep12',
        title: 'Отель Усадьба Державина',
        details: 'Прекрасный отель недалеко от Исаакиевского собора с бесплатным Wi-Fi на всей территории.',
        photos: ['bvep12.png', 'bvep12.png'],
        coordinates: [59.9194966, 30.309389],
        bookedDates: [],
        price: 8700
    }
];
export function cloneDate(date) {
    return new Date(date.getTime());
}
export function addDays(date, days) {
    date.setDate(date.getDate() + days);
    return date;
}
export const backendPort = 3040;
export const localStorageKey = 'flat-rent-db';
export class FlatRentSdk {
    constructor() {
        this._generateTransactionId = () => {
            const min = 1000;
            const max = 9999;
            const num = Math.random() * (max - min) + min;
            return Math.floor(num);
        };
        if (this._readDatabase() == null) {
            this._writeDatabase(database);
        }
        this.database = this._readDatabase();
    }
    /**
       * Get flat by ID.
       *
       * @param {string} id Flat ID.
       * @returns {Promise<Object|null>} Flat.
       */
    get(id) {
        const flat = this.database.find((item) => {
            return item.id === id;
        });
        return Promise.resolve(flat == null ? flat : this._formatFlatObject(flat));
    }
    /**
       * Search for flats.
       *
       * @param {Object} parameters Search parameters
       * @param {string}parameters.city City name
       * @param {Date} parameters.checkInDate Check-in date
       * @param {Date} parameters.checkOutDate Check-out date
       * @param {number} [parameters.priceLimit] Max price for a night
       * @returns {Object[]} List of suitable flats.
       */
    search(parameters) {
        return new Promise((resolve, reject) => {
            try {
                if (parameters.city != 'Санкт-Петербург') {
                    throw new Error(`Passed unsupported city - "${parameters.city}".`);
                }
                if (!(parameters.checkInDate instanceof Date) || !(parameters.checkOutDate instanceof Date)) {
                    throw new Error(`Passed invalid check-in or check-out date - from "${parameters.checkInDate}" to "${parameters.checkOutDate}".`);
                }
                this._assertDatesAreCorrect(parameters.checkInDate, parameters.checkOutDate);
                if (parameters.priceLimit != null && (isNaN(parameters.priceLimit) || !isFinite(parameters.priceLimit))) {
                    throw new Error(`Passed invalid price limit - "${parameters.priceLimit}".`);
                }
                let flats = this.database;
                if (parameters.priceLimit != null) {
                    flats = flats.filter((flat) => {
                        return flat.price <= parameters.priceLimit;
                    });
                }
                const dateRange = this._generateDateRange(parameters.checkInDate, parameters.checkOutDate);
                flats = flats.filter((flat) => {
                    return this._areAllDatesAvailable(flat, dateRange);
                });
                flats = flats.map((flat) => {
                    return this._formatFlatObject(flat, dateRange.length - 1);
                });
                resolve(flats);
            }
            catch (error) {
                reject(error);
            }
        });
    }
    /**
       * Book flat.
       *
       * @param {number} flatId
       * @param {Date} checkInDate
       * @param {Date} checkOutDate
       * @returns {number}
       */
    book(flatId, checkInDate, checkOutDate) {
        return new Promise((resolve, reject) => {
            try {
                const flat = this.database.find((item) => {
                    return item.id === flatId;
                });
                if (flat == null) {
                    throw new Error('There is no flat with ID "' + flatId + '".');
                }
                this._assertDatesAreCorrect(checkInDate, checkOutDate);
                const datesToBook = this._generateDateRange(checkInDate, checkOutDate);
                if (!this._areAllDatesAvailable(flat, datesToBook)) {
                    throw new Error(`Flat ${flat.id} is not available for dates ${datesToBook.join(',')}.`);
                }
                const bookedDates = datesToBook.map((date) => {
                    return date.getTime();
                });
                flat.bookedDates.push(...bookedDates);
                for (let i = 0; i < this.database.length; i++) {
                    if (this.database[i].id === flat.id) {
                        this.database[i] = flat;
                        break;
                    }
                }
                this._writeDatabase(this.database);
                resolve(this._generateTransactionId());
            }
            catch (error) {
                reject(error);
            }
        });
    }
    _assertDatesAreCorrect(checkInDate, checkOutDate) {
        const today = new Date();
        this._resetTime(today);
        this._resetTime(checkInDate);
        this._resetTime(checkOutDate);
        const diffToday = this._calculateDifferenceInDays(today, checkInDate);
        if (diffToday < 0) {
            throw new Error('Check-in date can\'t be in the past.');
        }
        const diffCheck = this._calculateDifferenceInDays(checkInDate, checkOutDate);
        if (diffCheck < 0) {
            throw new Error('Check-out date must be grater then check-in date.');
        }
    }
    _resetTime(date) {
        date.setHours(0);
        date.setMinutes(0);
        date.setSeconds(0);
        date.setMilliseconds(0);
    }
    _calculateDifferenceInDays(startDate, endDate) {
        const difference = endDate.getTime() - startDate.getTime();
        return Math.floor(difference / (1000 * 60 * 60 * 24));
    }
    _generateDateRange(from, to) {
        const dates = [];
        const differenceInDays = this._calculateDifferenceInDays(from, to);
        dates.push(new Date(from.getFullYear(), from.getMonth(), from.getDate()));
        for (let i = 1; i <= differenceInDays; i++) {
            dates.push(new Date(from.getFullYear(), from.getMonth(), from.getDate() + i));
        }
        return dates;
    }
    _areAllDatesAvailable(flat, dateRange) {
        return dateRange.every((date) => {
            return !flat.bookedDates.includes(date.getTime());
        });
    }
    _formatFlatObject(flat, nightNumber) {
        const formattedFlat = Object.assign({}, flat);
        formattedFlat.photos = formattedFlat.photos.map((photoUrl) => {
            return `http://localhost:${backendPort}/img/${photoUrl}`;
        });
        if (nightNumber != null) {
            formattedFlat.totalPrice = nightNumber * formattedFlat.price;
            delete formattedFlat.price;
        }
        return formattedFlat;
    }
    _readDatabase() {
        const data = window.localStorage.getItem(localStorageKey);
        if (data == null) {
            return data;
        }
        return JSON.parse(data);
    }
    _writeDatabase(database) {
        window.localStorage.setItem(localStorageKey, JSON.stringify(database));
    }
    _syncDatabase(database) {
        this._writeDatabase(database);
        this.database = this._readDatabase();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmxhdC1yZW50LXNkay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mbGF0LXJlbnQtc2RrLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE1BQU0sUUFBUSxHQUFHO0lBQ2Y7UUFDRSxFQUFFLEVBQUUsUUFBUTtRQUNaLEtBQUssRUFBRSxzQkFBc0I7UUFDN0IsT0FBTyxFQUFFLGdKQUFnSjtRQUN6SixNQUFNLEVBQUUsQ0FBQyxZQUFZLEVBQUUsWUFBWSxDQUFDO1FBQ3BDLFdBQVcsRUFBRSxDQUFDLFVBQVUsRUFBQyxVQUFVLENBQUM7UUFDcEMsV0FBVyxFQUFFLEVBQUU7UUFDZixLQUFLLEVBQUUsS0FBSztLQUNiO0lBQ0Q7UUFDRSxFQUFFLEVBQUUsT0FBTztRQUNYLEtBQUssRUFBRSxtQkFBbUI7UUFDMUIsT0FBTyxFQUFFLDZIQUE2SDtRQUN0SSxNQUFNLEVBQUUsQ0FBQyxXQUFXLEVBQUUsV0FBVyxDQUFDO1FBQ2xDLFdBQVcsRUFBRSxDQUFDLFNBQVMsRUFBQyxVQUFVLENBQUM7UUFDbkMsV0FBVyxFQUFFLEVBQUU7UUFDZixLQUFLLEVBQUUsSUFBSTtLQUNaO0lBQ0Q7UUFDRSxFQUFFLEVBQUUsUUFBUTtRQUNaLEtBQUssRUFBRSwyQkFBMkI7UUFDbEMsT0FBTyxFQUFFLDJJQUEySTtRQUNwSixNQUFNLEVBQUUsQ0FBQyxZQUFZLEVBQUUsWUFBWSxDQUFDO1FBQ3BDLFdBQVcsRUFBRSxDQUFDLFVBQVUsRUFBQyxVQUFVLENBQUM7UUFDcEMsV0FBVyxFQUFFLEVBQUU7UUFDZixLQUFLLEVBQUUsSUFBSTtLQUNaO0lBQ0Q7UUFDRSxFQUFFLEVBQUUsUUFBUTtRQUNaLEtBQUssRUFBRSx5QkFBeUI7UUFDaEMsT0FBTyxFQUFFLDBGQUEwRjtRQUNuRyxNQUFNLEVBQUUsQ0FBQyxZQUFZLEVBQUUsWUFBWSxDQUFDO1FBQ3BDLFdBQVcsRUFBRSxDQUFDLFVBQVUsRUFBQyxTQUFTLENBQUM7UUFDbkMsV0FBVyxFQUFF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QU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRTlDLGFBQWEsQ0FBQyxNQUFNLEdBQUcsYUFBYSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRTtZQUMzRCxPQUFPLG9CQUFvQixXQUFXLFFBQVEsUUFBUSxFQUFFLENBQUM7UUFDM0QsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLFdBQVcsSUFBSSxJQUFJLEVBQUU7WUFDdkIsYUFBYSxDQUFDLFVBQVUsR0FBRyxXQUFXLEdBQUcsYUFBYSxDQUFDLEtBQUssQ0FBQztZQUM3RCxPQUFPLGFBQWEsQ0FBQyxLQUFLLENBQUM7U0FDNUI7UUFFRCxPQUFPLGFBQWEsQ0FBQztJQUN2QixDQUFDO0lBRUQsYUFBYTtRQUNYLE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBRTFELElBQUksSUFBSSxJQUFJLElBQUksRUFBRTtZQUNoQixPQUFPLElBQUksQ0FBQztTQUNiO1FBRUQsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzFCLENBQUM7SUFFRCxjQUFjLENBQUMsUUFBUTtRQUNyQixNQUFNLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxlQUFlLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO0lBQ3pFLENBQUM7SUFFRCxhQUFhLENBQUMsUUFBUTtRQUNwQixJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzlCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3ZDLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGRhdGFiYXNlID0gW1xuICB7XG4gICAgaWQ6ICd2bmQzMzEnLFxuICAgIHRpdGxlOiAnUmFkaXNzb24gUm95YWwgSG90ZWwnLFxuICAgIGRldGFpbHM6ICfQntGC0LXQu9GMINGA0LDRgdC/0L7Qu9C+0LbQtdC9INCyIDQg0LzQuNC90YPRgtCw0YUg0YXQvtC00YzQsdGLINC+0YIg0YHRgtCw0L3RhtC40Lgg0LzQtdGC0YDQviDCq9Cc0LDRj9C60L7QstGB0LrQsNGPwrsuINCaINGD0YHQu9GD0LPQsNC8INCz0L7RgdGC0LXQuSDRhNC40YLQvdC10YEt0YbQtdC90YLRgCDQuCDRgdC/0LAt0YbQtdC90YLRgCDRgSDRgdCw0YPQvdC+0Lkg0Lgg0LPQuNC00YDQvtC80LDRgdGB0LDQttC90L7QuSDQstCw0L3QvdC+0LkuJyxcbiAgICBwaG90b3M6IFsndm5kMzMxLnBuZycsICd2bmQzMzEucG5nJ10sXG4gICAgY29vcmRpbmF0ZXM6IFs1OS45MzIyOTM2LDMwLjM0NjAxMjldLFxuICAgIGJvb2tlZERhdGVzOiBbXSxcbiAgICBwcmljZTogMTIwMDBcbiAgfSxcbiAge1xuICAgIGlkOiAnYWIyZTInLFxuICAgIHRpdGxlOiAn0J3QvtC80LXRgNCwINC90LAg0KHQsNC00L7QstC+0LknLFxuICAgIGRldGFpbHM6ICfQoNCw0YHQv9C+0LvQvtC20LXQvSDQsiA3INC80LjQvdGD0YLQsNGFINGF0L7QtNGM0LHRiyDQvtGCINCd0LXQstGB0LrQvtCz0L4g0L/RgNC+0YHQv9C10LrRgtCwLiDQmiDRg9GB0LvRg9Cz0LDQvCDQs9C+0YHRgtC10Lkg0LrRgNGD0LPQu9C+0YHRg9GC0L7Rh9C90LDRjyDRgdGC0L7QudC60LAg0YDQtdCz0LjRgdGC0YDQsNGG0LjQuCDQuCDQsdC10YHQv9C70LDRgtC90YvQuSBXaS1GaS4nLFxuICAgIHBob3RvczogWydhYjJlMi5wbmcnLCAnYWIyZTIucG5nJ10sXG4gICAgY29vcmRpbmF0ZXM6IFs1OS45MzAzMjUsMzAuMzI5MTU5Ml0sXG4gICAgYm9va2VkRGF0ZXM6IFtdLFxuICAgIHByaWNlOiA0NTAwXG4gIH0sXG4gIHtcbiAgICBpZDogJ212bTMybCcsXG4gICAgdGl0bGU6ICfQnNC40L3QuCDQntGC0LXQu9GMINC90LAg0J3QtdCy0YHQutC+0LwgMTM2JyxcbiAgICBkZXRhaWxzOiAn0JzQuNC90Lgt0L7RgtC10LvRjCDRgNCw0YHQv9C+0LvQvtC20LXQvSDQsiDQodCw0L3QutGCLdCf0LXRgtC10YDQsdGD0YDQs9C1LCDQsiA1INC80LjQvdGD0YLQsNGFINGF0L7QtNGM0LHRiyDQvtGCINGB0YLQsNC90YbQuNC4INC80LXRgtGA0L4gwqvQn9C70L7RidCw0LTRjCDQktC+0YHRgdGC0LDQvdC40Y/CuyDQuCDQnNC+0YHQutC+0LLRgdC60L7Qs9C+INC20LXQu9C10LfQvdC+0LTQvtGA0L7QttC90L7Qs9C+INCy0L7QutC30LDQu9CwLicsXG4gICAgcGhvdG9zOiBbJ212bTMybC5wbmcnLCAnbXZtMzJsLnBuZyddLFxuICAgIGNvb3JkaW5hdGVzOiBbNTkuOTI5OTYwMywzMC4zNjU4OTMyXSxcbiAgICBib29rZWREYXRlczogW10sXG4gICAgcHJpY2U6IDM4MDBcbiAgfSxcbiAge1xuICAgIGlkOiAnYnZlcDEyJyxcbiAgICB0aXRsZTogJ9Ce0YLQtdC70Ywg0KPRgdCw0LTRjNCx0LAg0JTQtdGA0LbQsNCy0LjQvdCwJyxcbiAgICBkZXRhaWxzOiAn0J/RgNC10LrRgNCw0YHQvdGL0Lkg0L7RgtC10LvRjCDQvdC10LTQsNC70LXQutC+INC+0YIg0JjRgdCw0LDQutC40LXQstGB0LrQvtCz0L4g0YHQvtCx0L7RgNCwINGBINCx0LXRgdC/0LvQsNGC0L3Ri9C8IFdpLUZpINC90LAg0LLRgdC10Lkg0YLQtdGA0YDQuNGC0L7RgNC40LguJyxcbiAgICBwaG90b3M6IFsnYnZlcDEyLnBuZycsICdidmVwMTIucG5nJ10sXG4gICAgY29vcmRpbmF0ZXM6IFs1OS45MTk0OTY2LDMwLjMwOTM4OV0sXG4gICAgYm9va2VkRGF0ZXM6IFtdLFxuICAgIHByaWNlOiA4NzAwXG4gIH1cbl07XG5cbmV4cG9ydCBmdW5jdGlvbiBjbG9uZURhdGUoZGF0ZSkge1xuICByZXR1cm4gbmV3IERhdGUoZGF0ZS5nZXRUaW1lKCkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYWRkRGF5cyhkYXRlLCBkYXlzKSB7XG4gIGRhdGUuc2V0RGF0ZShkYXRlLmdldERhdGUoKSArIGRheXMpO1xuICByZXR1cm4gZGF0ZTtcbn1cblxuZXhwb3J0IGNvbnN0IGJhY2tlbmRQb3J0ID0gMzA0MDtcbmV4cG9ydCBjb25zdCBsb2NhbFN0b3JhZ2VLZXkgPSAnZmxhdC1yZW50LWRiJztcblxuZXhwb3J0IGNsYXNzIEZsYXRSZW50U2RrIHtcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgaWYgKHRoaXMuX3JlYWREYXRhYmFzZSgpID09IG51bGwpIHtcbiAgICAgIHRoaXMuX3dyaXRlRGF0YWJhc2UoZGF0YWJhc2UpO1xuICAgIH1cblxuICAgIHRoaXMuZGF0YWJhc2UgPSB0aGlzLl9yZWFkRGF0YWJhc2UoKTtcbiAgfVxuXG4gIC8qKlxuICAgICAqIEdldCBmbGF0IGJ5IElELlxuICAgICAqIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBpZCBGbGF0IElELlxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlPE9iamVjdHxudWxsPn0gRmxhdC5cbiAgICAgKi9cbiAgZ2V0KGlkKSB7XG4gICAgY29uc3QgZmxhdCA9IHRoaXMuZGF0YWJhc2UuZmluZCgoaXRlbSkgPT4ge1xuICAgICAgcmV0dXJuIGl0ZW0uaWQgPT09IGlkO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmbGF0ID09IG51bGwgPyBmbGF0IDogdGhpcy5fZm9ybWF0RmxhdE9iamVjdChmbGF0KSk7XG4gIH1cblxuICAvKipcbiAgICAgKiBTZWFyY2ggZm9yIGZsYXRzLlxuICAgICAqIFxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBwYXJhbWV0ZXJzIFNlYXJjaCBwYXJhbWV0ZXJzXG4gICAgICogQHBhcmFtIHtzdHJpbmd9cGFyYW1ldGVycy5jaXR5IENpdHkgbmFtZVxuICAgICAqIEBwYXJhbSB7RGF0ZX0gcGFyYW1ldGVycy5jaGVja0luRGF0ZSBDaGVjay1pbiBkYXRlXG4gICAgICogQHBhcmFtIHtEYXRlfSBwYXJhbWV0ZXJzLmNoZWNrT3V0RGF0ZSBDaGVjay1vdXQgZGF0ZVxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbcGFyYW1ldGVycy5wcmljZUxpbWl0XSBNYXggcHJpY2UgZm9yIGEgbmlnaHRcbiAgICAgKiBAcmV0dXJucyB7T2JqZWN0W119IExpc3Qgb2Ygc3VpdGFibGUgZmxhdHMuXG4gICAgICovXG4gIHNlYXJjaChwYXJhbWV0ZXJzKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGlmIChwYXJhbWV0ZXJzLmNpdHkgIT0gJ9Ch0LDQvdC60YIt0J/QtdGC0LXRgNCx0YPRgNCzJykge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUGFzc2VkIHVuc3VwcG9ydGVkIGNpdHkgLSBcIiR7cGFyYW1ldGVycy5jaXR5fVwiLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCEocGFyYW1ldGVycy5jaGVja0luRGF0ZSBpbnN0YW5jZW9mIERhdGUpIHx8ICEocGFyYW1ldGVycy5jaGVja091dERhdGUgaW5zdGFuY2VvZiBEYXRlKSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUGFzc2VkIGludmFsaWQgY2hlY2staW4gb3IgY2hlY2stb3V0IGRhdGUgLSBmcm9tIFwiJHtwYXJhbWV0ZXJzLmNoZWNrSW5EYXRlfVwiIHRvIFwiJHtwYXJhbWV0ZXJzLmNoZWNrT3V0RGF0ZX1cIi5gKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9hc3NlcnREYXRlc0FyZUNvcnJlY3QocGFyYW1ldGVycy5jaGVja0luRGF0ZSwgcGFyYW1ldGVycy5jaGVja091dERhdGUpO1xuXG4gICAgICAgIGlmIChwYXJhbWV0ZXJzLnByaWNlTGltaXQgIT0gbnVsbCAmJiAoaXNOYU4ocGFyYW1ldGVycy5wcmljZUxpbWl0KSB8fCAhaXNGaW5pdGUocGFyYW1ldGVycy5wcmljZUxpbWl0KSkpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFBhc3NlZCBpbnZhbGlkIHByaWNlIGxpbWl0IC0gXCIke3BhcmFtZXRlcnMucHJpY2VMaW1pdH1cIi5gKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgbGV0IGZsYXRzID0gdGhpcy5kYXRhYmFzZTtcbiAgICAgICAgXG4gICAgICAgIGlmIChwYXJhbWV0ZXJzLnByaWNlTGltaXQgIT0gbnVsbCkge1xuICAgICAgICAgIGZsYXRzID0gZmxhdHMuZmlsdGVyKChmbGF0KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gZmxhdC5wcmljZSA8PSBwYXJhbWV0ZXJzLnByaWNlTGltaXQ7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGNvbnN0IGRhdGVSYW5nZSA9IHRoaXMuX2dlbmVyYXRlRGF0ZVJhbmdlKHBhcmFtZXRlcnMuY2hlY2tJbkRhdGUsIHBhcmFtZXRlcnMuY2hlY2tPdXREYXRlKTtcbiAgICAgICAgZmxhdHMgPSBmbGF0cy5maWx0ZXIoKGZsYXQpID0+IHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5fYXJlQWxsRGF0ZXNBdmFpbGFibGUoZmxhdCwgZGF0ZVJhbmdlKTtcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICBmbGF0cyA9IGZsYXRzLm1hcCgoZmxhdCkgPT4ge1xuICAgICAgICAgIHJldHVybiB0aGlzLl9mb3JtYXRGbGF0T2JqZWN0KGZsYXQsIGRhdGVSYW5nZS5sZW5ndGggLSAxKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmVzb2x2ZShmbGF0cyk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAgICogQm9vayBmbGF0LlxuICAgICAqIFxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBmbGF0SWQgXG4gICAgICogQHBhcmFtIHtEYXRlfSBjaGVja0luRGF0ZSBcbiAgICAgKiBAcGFyYW0ge0RhdGV9IGNoZWNrT3V0RGF0ZVxuICAgICAqIEByZXR1cm5zIHtudW1iZXJ9XG4gICAgICovXG4gIGJvb2soZmxhdElkLCBjaGVja0luRGF0ZSwgY2hlY2tPdXREYXRlKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGZsYXQgPSB0aGlzLmRhdGFiYXNlLmZpbmQoKGl0ZW0pID0+IHtcbiAgICAgICAgICByZXR1cm4gaXRlbS5pZCA9PT0gZmxhdElkO1xuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIGlmIChmbGF0ID09IG51bGwpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZXJlIGlzIG5vIGZsYXQgd2l0aCBJRCBcIicgKyBmbGF0SWQgKyAnXCIuJyk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fYXNzZXJ0RGF0ZXNBcmVDb3JyZWN0KGNoZWNrSW5EYXRlLCBjaGVja091dERhdGUpO1xuICAgICAgICBcbiAgICAgICAgY29uc3QgZGF0ZXNUb0Jvb2sgPSB0aGlzLl9nZW5lcmF0ZURhdGVSYW5nZShjaGVja0luRGF0ZSwgY2hlY2tPdXREYXRlKTtcbiAgICAgICAgaWYgKCF0aGlzLl9hcmVBbGxEYXRlc0F2YWlsYWJsZShmbGF0LCBkYXRlc1RvQm9vaykpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZsYXQgJHtmbGF0LmlkfSBpcyBub3QgYXZhaWxhYmxlIGZvciBkYXRlcyAke2RhdGVzVG9Cb29rLmpvaW4oJywnKX0uYCk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGNvbnN0IGJvb2tlZERhdGVzID0gZGF0ZXNUb0Jvb2subWFwKChkYXRlKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGRhdGUuZ2V0VGltZSgpO1xuICAgICAgICB9KTtcbiAgICAgICAgZmxhdC5ib29rZWREYXRlcy5wdXNoKC4uLmJvb2tlZERhdGVzKTtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmRhdGFiYXNlLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgaWYgKHRoaXMuZGF0YWJhc2VbaV0uaWQgPT09IGZsYXQuaWQpIHtcbiAgICAgICAgICAgIHRoaXMuZGF0YWJhc2VbaV0gPSBmbGF0O1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3dyaXRlRGF0YWJhc2UodGhpcy5kYXRhYmFzZSk7XG4gICAgICAgIFxuICAgICAgICByZXNvbHZlKHRoaXMuX2dlbmVyYXRlVHJhbnNhY3Rpb25JZCgpKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBfYXNzZXJ0RGF0ZXNBcmVDb3JyZWN0KGNoZWNrSW5EYXRlLCBjaGVja091dERhdGUpIHtcbiAgICBjb25zdCB0b2RheSA9IG5ldyBEYXRlKCk7XG4gICAgdGhpcy5fcmVzZXRUaW1lKHRvZGF5KTtcbiAgICB0aGlzLl9yZXNldFRpbWUoY2hlY2tJbkRhdGUpO1xuICAgIHRoaXMuX3Jlc2V0VGltZShjaGVja091dERhdGUpO1xuXG4gICAgY29uc3QgZGlmZlRvZGF5ID0gdGhpcy5fY2FsY3VsYXRlRGlmZmVyZW5jZUluRGF5cyh0b2RheSwgY2hlY2tJbkRhdGUpO1xuICAgIGlmIChkaWZmVG9kYXkgPCAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NoZWNrLWluIGRhdGUgY2FuXFwndCBiZSBpbiB0aGUgcGFzdC4nKTtcbiAgICB9XG5cbiAgICBjb25zdCBkaWZmQ2hlY2sgPSB0aGlzLl9jYWxjdWxhdGVEaWZmZXJlbmNlSW5EYXlzKGNoZWNrSW5EYXRlLCBjaGVja091dERhdGUpO1xuICAgIGlmIChkaWZmQ2hlY2sgPCAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NoZWNrLW91dCBkYXRlIG11c3QgYmUgZ3JhdGVyIHRoZW4gY2hlY2staW4gZGF0ZS4nKTtcbiAgICB9XG4gIH1cblxuICBfcmVzZXRUaW1lKGRhdGUpIHtcbiAgICBkYXRlLnNldEhvdXJzKDApO1xuICAgIGRhdGUuc2V0TWludXRlcygwKTtcbiAgICBkYXRlLnNldFNlY29uZHMoMCk7XG4gICAgZGF0ZS5zZXRNaWxsaXNlY29uZHMoMCk7XG4gIH1cblxuICBfY2FsY3VsYXRlRGlmZmVyZW5jZUluRGF5cyhzdGFydERhdGUsIGVuZERhdGUpIHtcbiAgICBjb25zdCBkaWZmZXJlbmNlID0gZW5kRGF0ZS5nZXRUaW1lKCkgLSBzdGFydERhdGUuZ2V0VGltZSgpO1xuXG4gICAgcmV0dXJuIE1hdGguZmxvb3IoZGlmZmVyZW5jZSAvICgxMDAwICogNjAgKiA2MCAqIDI0KSk7XG4gIH1cblxuICBfZ2VuZXJhdGVEYXRlUmFuZ2UoZnJvbSwgdG8pIHtcbiAgICBjb25zdCBkYXRlcyA9IFtdO1xuICAgIGNvbnN0IGRpZmZlcmVuY2VJbkRheXMgPSB0aGlzLl9jYWxjdWxhdGVEaWZmZXJlbmNlSW5EYXlzKGZyb20sIHRvKTtcbiAgICAgICAgXG4gICAgZGF0ZXMucHVzaChuZXcgRGF0ZShmcm9tLmdldEZ1bGxZZWFyKCksIGZyb20uZ2V0TW9udGgoKSwgZnJvbS5nZXREYXRlKCkpKTtcbiAgICBmb3IgKGxldCBpID0gMTsgaSA8PSBkaWZmZXJlbmNlSW5EYXlzOyBpKyspIHtcbiAgICAgIGRhdGVzLnB1c2gobmV3IERhdGUoZnJvbS5nZXRGdWxsWWVhcigpLCBmcm9tLmdldE1vbnRoKCksIGZyb20uZ2V0RGF0ZSgpICsgaSkpO1xuICAgIH1cbiAgICBcbiAgICByZXR1cm4gZGF0ZXM7XG4gIH1cblxuICBfZ2VuZXJhdGVUcmFuc2FjdGlvbklkID0gKCkgPT4ge1xuICAgIGNvbnN0IG1pbiA9IDEwMDA7XG4gICAgY29uc3QgbWF4ID0gOTk5OTtcbiAgICBjb25zdCBudW0gPSBNYXRoLnJhbmRvbSgpICogKG1heCAtIG1pbikgKyBtaW47XG4gICAgXG4gICAgcmV0dXJuIE1hdGguZmxvb3IobnVtKTtcbiAgfTtcblxuICBfYXJlQWxsRGF0ZXNBdmFpbGFibGUoZmxhdCwgZGF0ZVJhbmdlKSB7XG4gICAgcmV0dXJuIGRhdGVSYW5nZS5ldmVyeSgoZGF0ZSkgPT4ge1xuICAgICAgcmV0dXJuICFmbGF0LmJvb2tlZERhdGVzLmluY2x1ZGVzKGRhdGUuZ2V0VGltZSgpKTtcbiAgICB9KTtcbiAgfVxuXG4gIF9mb3JtYXRGbGF0T2JqZWN0KGZsYXQsIG5pZ2h0TnVtYmVyKSB7XG4gICAgY29uc3QgZm9ybWF0dGVkRmxhdCA9IE9iamVjdC5hc3NpZ24oe30sIGZsYXQpO1xuXG4gICAgZm9ybWF0dGVkRmxhdC5waG90b3MgPSBmb3JtYXR0ZWRGbGF0LnBob3Rvcy5tYXAoKHBob3RvVXJsKSA9PiB7XG4gICAgICByZXR1cm4gYGh0dHA6Ly9sb2NhbGhvc3Q6JHtiYWNrZW5kUG9ydH0vaW1nLyR7cGhvdG9Vcmx9YDtcbiAgICB9KTtcblxuICAgIGlmIChuaWdodE51bWJlciAhPSBudWxsKSB7XG4gICAgICBmb3JtYXR0ZWRGbGF0LnRvdGFsUHJpY2UgPSBuaWdodE51bWJlciAqIGZvcm1hdHRlZEZsYXQucHJpY2U7XG4gICAgICBkZWxldGUgZm9ybWF0dGVkRmxhdC5wcmljZTtcbiAgICB9XG5cbiAgICByZXR1cm4gZm9ybWF0dGVkRmxhdDtcbiAgfVxuXG4gIF9yZWFkRGF0YWJhc2UoKSB7XG4gICAgY29uc3QgZGF0YSA9IHdpbmRvdy5sb2NhbFN0b3JhZ2UuZ2V0SXRlbShsb2NhbFN0b3JhZ2VLZXkpO1xuXG4gICAgaWYgKGRhdGEgPT0gbnVsbCkge1xuICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfVxuXG4gICAgcmV0dXJuIEpTT04ucGFyc2UoZGF0YSk7XG4gIH1cblxuICBfd3JpdGVEYXRhYmFzZShkYXRhYmFzZSkge1xuICAgIHdpbmRvdy5sb2NhbFN0b3JhZ2Uuc2V0SXRlbShsb2NhbFN0b3JhZ2VLZXksIEpTT04uc3RyaW5naWZ5KGRhdGFiYXNlKSk7XG4gIH1cblxuICBfc3luY0RhdGFiYXNlKGRhdGFiYXNlKSB7XG4gICAgdGhpcy5fd3JpdGVEYXRhYmFzZShkYXRhYmFzZSk7XG4gICAgdGhpcy5kYXRhYmFzZSA9IHRoaXMuX3JlYWREYXRhYmFzZSgpO1xuICB9XG59XG4iXX0=